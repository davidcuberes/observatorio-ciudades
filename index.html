<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üìä Visualizador de Indicadores CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem;
      background: #fafafa;
      color: #222;
    }
    h1 { color: #1e3a8a; }
    #links a {
      display: inline-block;
      margin: 4px 6px;
      padding: 6px 10px;
      background: #e0e7ff;
      border-radius: 6px;
      text-decoration: none;
      color: #1e3a8a;
    }
    #links a:hover {
      background: #c7d2fe;
    }
    #chartContainer {
      display: none;
      margin-top: 20px;
    }
    #cityButtons button {
      margin: 0 5px 10px 0;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    #cityButtons button:hover {
      background: #1d4ed8;
    }
    footer {
      margin-top: 20px;
      font-size: 0.85em;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>üìä Visualizador de Indicadores CSV</h1>
  <div id="instructions">Los datos se cargan autom√°ticamente desde <code>data.csv</code>.</div>
  <div id="message">Cargando datos...</div>
  <div id="links"></div>

  <div id="chartContainer">
    <h2 id="cityName"></h2>
    <canvas id="chart" width="800" height="400"></canvas>
    <div id="cityButtons"></div>
    <button id="backBtn">‚¨ÖÔ∏è Volver</button>
    <footer id="footnote"></footer>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("‚úÖ Script loaded correctly");

    let chart;
    let dataRows = [];
    let globalMeans = {};
    let allYears = [];

    const messageDiv = document.getElementById("message");
    const chartContainer = document.getElementById("chartContainer");
    const linksDiv = document.getElementById("links");
    const instructionsEl = document.getElementById("instructions");
    const backBtn = document.getElementById("backBtn");
    const cityNameDiv = document.getElementById("cityName");
    const footnote = document.getElementById("footnote");

    const vars = ["cu√±a_laboral","eficiencia","amenidades","fricciones_excesivas"];

    // Try to load CSV automatically
    try {
      const response = await fetch("./data.csv");
      if (!response.ok) throw new Error("‚ùå No se pudo cargar data.csv");
      const text = await response.text();
      parseCSV(text);
      computeGlobalMeans();
      dataRows.sort((a,b)=>a.AUF.localeCompare(b.AUF,"es",{sensitivity:"base"}));
      createLinks(dataRows);
      messageDiv.textContent = "‚úÖ Datos cargados autom√°ticamente desde data.csv.";
    } catch (err) {
      console.error(err);
      messageDiv.textContent = "‚ö†Ô∏è Error al cargar data.csv. Verifique que est√© en la misma carpeta que index.html.";
    }

    function parseCSV(text) {
      const rows = text.trim().split(/\r?\n/);
      const headers = rows[0].split(",");
      dataRows = rows.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h,i) => obj[h.trim()] = isNaN(values[i]) ? values[i].trim() : +values[i]);
        return obj;
      });
    }

    function computeGlobalMeans() {
      allYears = [...new Set(dataRows.map(d => d.a√±o))].sort((a,b)=>a-b);
      vars.forEach(v => {
        const vals = dataRows.map(d => parseFloat(d[v])).filter(n => !isNaN(n));
        globalMeans[v] = vals.reduce((a,b)=>a+b,0)/vals.length;
      });
      console.log("üåç Global means:", globalMeans);
      console.log("üìÖ All years:", allYears);
    }

    function createLinks(data){
      linksDiv.innerHTML="";
      const uniqueCities=[...new Set(data.map(d=>d.AUF))];
      uniqueCities.forEach(city=>{
        const a=document.createElement("a");
        a.href="#";
        a.textContent=city;
        a.onclick=e=>{
          e.preventDefault();
          showCityOptions(city);
        };
        linksDiv.appendChild(a);
      });
    }

    function showCityOptions(city){
      linksDiv.style.display="none";
      instructionsEl.style.display="none";
      messageDiv.style.display="none";
      chartContainer.style.display="block";
      cityNameDiv.textContent=city;

      const btnContainer=document.getElementById("cityButtons");
      btnContainer.innerHTML=`<button id="avgBtn">üìä Ver promedio</button> <button id="evolBtn">üìà Evoluci√≥n</button>`;

      document.getElementById("avgBtn").onclick=()=>showChart(city,"average");
      document.getElementById("evolBtn").onclick=()=>showChart(city,"time");
      showChart(city,"average");
    }

    function showChart(city, mode) {
      const cityData = dataRows.filter(d => d.AUF === city);
      const ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();

      const labels = ["Cu√±a laboral", "Eficiencia", "Amenidades", "Fricciones excesivas"];

      if (mode === "average") {
        const cityAverages = vars.map(v => {
          const vals = cityData.map(d => d[v]).filter(n => !isNaN(n));
          return vals.reduce((a,b)=>a+b,0)/vals.length;
        });

        const meanValues = vars.map(v => globalMeans[v]);

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: city, data: cityAverages, backgroundColor: "#4e79a7" },
              { label: "Media global", data: meanValues, backgroundColor: "#f28e2b" }
            ]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
        footnote.textContent = "";

      } else {
        const datasets = vars.map((v, i) => ({
          label: labels[i],
          data: allYears.map(y => {
            const entry = cityData.find(d => d.a√±o === y);
            return entry ? entry[v] : null;
          }),
          borderColor: ["#4e79a7", "#f28e2b", "#e15759", "#76b7b2"][i],
          tension: 0.3,
          yAxisID: v === "eficiencia" ? "y1" : "y"
        }));

        chart = new Chart(ctx, {
          type: "line",
          data: { labels: allYears, datasets },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            scales: {
              y: { beginAtZero: true, position: "left" },
              y1: {
                beginAtZero: true,
                position: "right",
                grid: { drawOnChartArea: false },
                title: { display: true, text: "Eficiencia (escala secundaria)" }
              }
            },
            plugins: { legend: { position: "bottom" } }
          }
        });
        footnote.textContent = "Nota: La variable 'Eficiencia' usa la escala del eje derecho.";
      }
    }

    backBtn.onclick=()=>{
      chartContainer.style.display="none";
      linksDiv.style.display="flex";
      instructionsEl.style.display="block";
      messageDiv.style.display="block";
    };
  });
  </script>
</body>
</html>
