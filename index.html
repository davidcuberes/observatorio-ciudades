<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üìä Visualizador de Indicadores Urbanos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      margin: 0;
      background: #f9fafb;
      color: #1e293b;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #2563eb, #1e3a8a);
      color: white;
      padding: 1.5rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 600;
    }

    #message {
      text-align: center;
      padding: 1rem;
      color: #475569;
      font-size: 0.95rem;
    }

    #links {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      padding: 1rem 2rem;
      max-width: 1000px;
      margin: 0 auto;
      flex-grow: 1;
    }

    #links a {
      display: block;
      text-align: center;
      padding: 8px 10px;
      background: white;
      border-radius: 10px;
      text-decoration: none;
      color: #1e3a8a;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      transition: all 0.2s ease;
    }

    #links a:hover {
      background: #e0e7ff;
      transform: translateY(-2px);
    }

    #chartContainer {
      display: none;
      padding: 2rem;
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    #cityName {
      text-align: center;
      margin-bottom: 0.5rem;
      color: #1e3a8a;
    }

    #cityButtons {
      text-align: center;
      margin-bottom: 1rem;
    }

    #cityButtons button, #backBtn {
      margin: 0 5px 10px 0;
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s ease;
    }

    #cityButtons button:hover, #backBtn:hover {
      background: #1d4ed8;
    }

    #backBtn {
      display: block;
      margin: 1rem auto 0;
    }

    footer {
      text-align: center;
      font-size: 0.9em;
      color: #555;
      padding: 1rem;
      border-top: 1px solid #e2e8f0;
      background: #f1f5f9;
      margin-top: auto;
    }

    footer em {
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä Visualizador de Indicadores Urbanos</h1>
  </header>

  <div id="message">Cargando datos...</div>
  <div id="links"></div>

  <div id="chartContainer">
    <h2 id="cityName"></h2>
    <div id="cityButtons"></div>
    <canvas id="chart" width="800" height="400"></canvas>
    <button id="backBtn">‚¨ÖÔ∏è Volver</button>
    <footer id="footnote"></footer>
  </div>

  <footer>
    From David Cuberes, Enrique Moral-Benito, and Javier Quintana:
    <em>"Urban Accounting and Welfare in Spain"</em>,
    Regional Science and Urban Economics (2025)
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("‚úÖ Script loaded correctly");

    let chart;
    let dataRows = [];
    let globalMeans = {};
    let allYears = [];

    const messageDiv = document.getElementById("message");
    const chartContainer = document.getElementById("chartContainer");
    const linksDiv = document.getElementById("links");
    const backBtn = document.getElementById("backBtn");
    const cityNameDiv = document.getElementById("cityName");
    const footnote = document.getElementById("footnote");

    const vars = ["cu√±a_laboral","eficiencia","amenidades","fricciones_excesivas"];

    try {
      const response = await fetch("./data.csv");
      if (!response.ok) throw new Error("‚ùå No se pudo cargar data.csv");
      const text = await response.text();
      parseCSV(text);
      computeGlobalMeans();
      dataRows.sort((a,b)=>a.AUF.localeCompare(b.AUF,"es",{sensitivity:"base"}));
      createLinks(dataRows);
      messageDiv.textContent = ""; // ‚úÖ Removed "Datos cargados correctamente."
    } catch (err) {
      console.error(err);
      messageDiv.textContent = "‚ö†Ô∏è Error al cargar data.csv. Verifique que est√© en la misma carpeta que index.html.";
    }

    function parseCSV(text) {
      const rows = text.trim().split(/\r?\n/);
      const headers = rows[0].split(",");
      dataRows = rows.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h,i) => obj[h.trim()] = isNaN(values[i]) ? values[i].trim() : +values[i]);
        return obj;
      });
    }

    function computeGlobalMeans() {
      allYears = [...new Set(dataRows.map(d => d.a√±o))].sort((a,b)=>a-b);
      vars.forEach(v => {
        const vals = dataRows.map(d => parseFloat(d[v])).filter(n => !isNaN(n));
        globalMeans[v] = vals.reduce((a,b)=>a+b,0)/vals.length;
      });
    }

    function createLinks(data){
      linksDiv.innerHTML="";
      const uniqueCities=[...new Set(data.map(d=>d.AUF))];
      uniqueCities.forEach(city=>{
        const a=document.createElement("a");
        a.href="#";
        a.textContent=city;
        a.onclick=e=>{
          e.preventDefault();
          showCityOptions(city);
        };
        linksDiv.appendChild(a);
      });
    }

    function showCityOptions(city){
      linksDiv.style.display="none";
      messageDiv.style.display="none";
      chartContainer.style.display="block";
      cityNameDiv.textContent=city;

      const btnContainer=document.getElementById("cityButtons");
      btnContainer.innerHTML=`<button id="avgBtn">üìä Ver promedio</button> <button id="evolBtn">üìà Evoluci√≥n</button>`;

      document.getElementById("avgBtn").onclick=()=>showChart(city,"average");
      document.getElementById("evolBtn").onclick=()=>showChart(city,"time");
      showChart(city,"average");
    }

    function showChart(city, mode) {
      const cityData = dataRows.filter(d => d.AUF === city);
      const ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();

      const labels = ["Cu√±a laboral", "Eficiencia", "Amenidades", "Fricciones excesivas"];

      if (mode === "average") {
        const cityAverages = vars.map(v => {
          const vals = cityData.map(d => d[v]).filter(n => !isNaN(n));
          return vals.reduce((a,b)=>a+b,0)/vals.length;
        });
        const meanValues = vars.map(v => globalMeans[v]);
        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: city, data: cityAverages, backgroundColor: "#4e79a7" },
              { label: "Media global", data: meanValues, backgroundColor: "#f28e2b" }
            ]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
        footnote.textContent = "";

      } else {
        const datasets = vars.map((v, i) => ({
          label: labels[i],
          data: allYears.map(y => {
            const entry = cityData.find(d => d.a√±o === y);
            return entry ? entry[v] : null;
          }),
          borderColor: ["#4e79a7", "#f28e2b", "#e15759", "#76b7b2"][i],
          tension: 0.3,
          yAxisID: v === "eficiencia" ? "y1" : "y"
        }));

        chart = new Chart(ctx, {
          type: "line",
          data: { labels: allYears, datasets },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            scales: {
              y: { beginAtZero: true, position: "left" },
              y1: {
                beginAtZero: true,
                position: "right",
                grid: { drawOnChartArea: false },
                title: { display: true, text: "Eficiencia (escala secundaria)" }
              }
            },
            plugins: { legend: { position: "bottom" } }
          }
        });
        footnote.textContent = "Nota: La variable 'Eficiencia' usa la escala del eje derecho.";
      }
    }

    backBtn.onclick=()=>{
      chartContainer.style.display="none";
      linksDiv.style.display="grid";
      messageDiv.style.display="block";
    };
  });
  </script>
</body>
</html>
